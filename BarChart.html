<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Bar Chart</title>
        <script type="text/javascript" src="d3.v2.js"></script>
        <script src="CSVToArray.js" type="text/javascript"></script>
        <script type="text/javascript" src="d3_exp_2.js"></script>
        <style type="text/css">
            body { margin: 0; padding 0; }
            svg { shape-rendering: crispEdges; }
        </style>
        <script type="text/javascript">

var didLoadFile = false;
var dataArray;

var heights = [];
var countPerHeight = [];
var sortedHeights = [];
var sortedCountPerHeight = [];

var screenWidth;
var screenHeight;

function bodyLoaded()
{
    screenWidth = window.innerWidth;
    screenHeight = window.innerHeight;
    loadData();
    draw();
}

function loadData()
{
    try {
        var request = new XMLHttpRequest();
        request.open("GET", "BookProject_all.csv", false);
        request.send();
        didLoadFile = (request.responseText != "")
        if (didLoadFile) {
            dataArray = CSVToArray(request.responseText);
            calculateData();
        }
    }
    catch (e) {
        console.log(e)
    }
    finally {
        delete request;
    }
}

function calculateData()
{
    for (var i = 1; i < dataArray.length; i++) {
        var height = Math.round(dataArray[i][1]);
        var foundHeight = false;
        for (var j = 0; j < heights.length; j++) {
            if (height === heights[j]) {
                foundHeight = true;
                countPerHeight[j]++;
                break;
            }
        }
        if (false === foundHeight) {
            var newHeightIndex = heights.length;
            heights[newHeightIndex] = height;
            countPerHeight[newHeightIndex] = 1;
        }
    }
    sortedHeights = heights.slice(0);
    function sortNumber(a, b) { 
        return a - b;
    }
    sortedHeights.sort(sortNumber);
    for (var i = 0; i < heights.length; i++) {
        for (var j = 0; j < sortedHeights.length; j++) {
            if (heights[i] === sortedHeights[j]) {
                sortedCountPerHeight[j] = countPerHeight[i];
                break;
            }
        }
    }
}

function draw() {
    var maxCount = 0;
    for (var i = 0; i < sortedCountPerHeight.length; i++) {
        if (sortedCountPerHeight[i] > maxCount) {
            maxCount = sortedCountPerHeight[i];
        }
    }
    maxCount = Math.ceil(maxCount * 1.2);
        
    var calcBarXPos = d3.scale.ordinal().domain(d3.range(sortedCountPerHeight.length)).rangeBands([0, screenWidth], .4);
    var calcBarHeight = d3.scale.linear().domain([0, maxCount]).range([0, screenHeight]);
    
    var vis = d3.select("body")
      .append("svg")
        .attr("width", screenWidth)
        .attr("height", screenHeight)
      .append("g")
        .attr("transform", "matrix(1, 0, 0, -1, 0, " + screenHeight + ")");
    
    var bars = vis.selectAll("bar")
        .data(sortedCountPerHeight)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d, i) { return "translate(" + calcBarXPos(i) + ",0)"; });

    
    bars.append("rect")
        .attr("fill", "steelblue")
        .attr("width", calcBarXPos.rangeBand())
        .attr("height", calcBarHeight);

/*
    bars.append("svg:text")
        .attr("x", calcBarXPos.rangeBand() / 2)
        .attr("y", calcBarHeight)
        .attr("dx", -6)
        .attr("fill", "white")
        .attr("text-anchor", "end")
        .text(x.tickFormat(100));
*/
}

        </script>
    </head>
    <body onLoad="bodyLoaded()">
    </body>
</html>
